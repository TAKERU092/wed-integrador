<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Artia Pastelería - Eventos</title>

  <link rel="stylesheet" href="/css/inicio.css">
  <link rel="stylesheet" href="/css/eventos.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0">

  <style>
    .toast{position:fixed;right:16px;bottom:16px;background:#2e7d32;color:#fff;padding:12px 16px;border-radius:8px;display:none;z-index:60}
    .toast.show{display:block}
    .form-card{background:#fff;border:1px solid #e2d6c9;border-radius:12px;padding:18px;max-width:1000px;margin:0 auto}
    .form-group-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .form-field{display:flex;flex-direction:column;gap:6px}
    .form-field input,.form-field select,.form-field textarea{padding:10px;border:1px solid #d7c6b6;border-radius:8px}
    .full-width{grid-column:1/-1}
    .btn-submit-form{display:inline-block;background:#6b3e1e;color:#fff;border:none;border-radius:10px;padding:12px 16px;font-weight:700;cursor:pointer}
    .section-title{text-align:center;margin:18px 0 8px}
    .card{border:1px solid #e2d6c9;border-radius:10px;padding:12px;background:#fff;margin:10px 0}
    .meta{display:grid;grid-template-columns:repeat(2,1fr);gap:6px}
    .hint{color:#6b6b6b}
  </style>
</head>
<body class="page-eventos">
<header>
  <div class="header-top">
    <a href="#" class="logo">
      <img src="/img/logo.png" alt="Artia Logo" />
    </a>

    <div class="search-container">
      <span class="material-symbols-outlined" aria-hidden="true">search</span>
      <input type="text" placeholder="¿Qué comemos hoy...?" aria-label="Buscar"/>
    </div>

    <div class="header-icons">
      <button class="icon-btn" aria-label="Notificaciones">
        <span class="material-symbols-outlined">notifications</span>
      </button>

      <div class="user-wrap">
        <button id="userBtn" class="icon-btn" aria-label="Perfil">
          <span class="material-symbols-outlined">account_circle</span>
        </button>

        <div id="userMenu" class="user-menu" hidden>
          <div class="user-menu-header">
            <span id="userName">Invitado</span>
          </div>
          <a href="/login.html" id="loginLink">Iniciar sesión</a>
          <a href="/registro.html" id="registerLink">Crear cuenta</a>
          <button id="logoutBtn" class="logout-btn">Cerrar sesión</button>
        </div>
      </div>

    <a href="carrito.html">
  <button class="icon-btn" aria-label="Carrito">
    <span class="material-symbols-outlined">shopping_cart</span>
  </button>
</a>
    </div>
  </div>
</header>
<nav class="main-nav" id="mainNav">
  <ul>
      <li><a href="/inicio.html">Inicio</a></li>
    <li><a href="/nosotros.html">Nosotros</a></li>
    <li><a href="/catalogo.html">Catálogo</a></li>
    <li><a href="/eventos.html" class="active">Eventos</a></li>
    <li><a href="/contacto.html">Contacto</a></li>
    <li><a href="/reseñas.html">Reseñas</a></li>
    <li><a href="/foro.html">Foro</a></li>
    <li><a href="/puntos.html">Puntos</a></li>
  </ul>
</nav>

<main id="eventos">
  <section class="solicita-evento-section" id="solicita-evento">
    <h2 class="section-title">¡SOLICITA TU EVENTO AQUÍ!</h2>
    <div class="form-card">
      <form id="form-evento" class="solicita-form" novalidate>
        <div class="form-group-row">
          <div class="form-field">
            <label for="tipo_evento">Tipo de Evento</label>
            <select id="tipo_evento">
              <option value="" selected>Selecciona…</option>
              <option value="Boda">Boda</option>
              <option value="Cumpleaños/Aniversario">Cumpleaños / Aniversario</option>
              <option value="Corporativo">Corporativo</option>
              <option value="Otro">Otro</option>
            </select>
          </div>
          <div class="form-field">
            <label for="invitados">Invitados (opcional)</label>
            <input type="number" id="invitados" min="10" placeholder="Ej. 50"/>
          </div>
        </div>

        <div class="form-group-row">
          <div class="form-field">
            <label for="fecha">Fecha del Evento</label>
            <input type="date" id="fecha" required/>
          </div>
          <div class="form-field">
            <label for="hora">Hora del Evento</label>
            <input type="time" id="hora"/>
          </div>
        </div>

        <div class="form-group-row">
          <div class="form-field">
            <label for="distrito">Distrito</label>
            <select id="distrito">
              <option value="">Selecciona…</option>
              <option>Ica</option><option>La Tinguiña</option><option>Los Aquijes</option>
              <option>Ocucaje</option><option>Pachacútec</option><option>Parcona</option>
              <option>Pueblo Nuevo</option><option>Salas</option>
              <option>San José de los Molinos</option><option>San Juan Bautista</option>
              <option>Santiago</option><option>Subtanjalla</option><option>Tate</option>
              <option>Yauca del Rosario</option>
            </select>
          </div>
          <div class="form-field">
            <label for="direccion">Dirección</label>
            <input id="direccion" type="text" placeholder="Ej. Av. Lima 123"/>
          </div>
        </div>

        <div class="form-group-row full-width">
          <div class="form-field full-width">
            <label for="referencia">Referencia</label>
            <input id="referencia" type="text" placeholder="Frente al parque…"/>
          </div>
        </div>

        <div class="form-group-row full-width">
          <div class="form-field full-width">
            <label for="detalles">Comentarios / Detalles</label>
            <textarea id="detalles" rows="3" placeholder="Cuéntanos más…"></textarea>
          </div>
        </div>

        <button type="submit" class="btn-submit-form">ENVIAR SOLICITUD</button>
        <small class="hint">El estado queda <b>EN_REVISION</b> hasta confirmar.</small>
      </form>
    </div>
  </section>

  <section class="section-card" style="margin-top:18px">
    <h2 class="section-title">Mis eventos</h2>
    <div id="historial-eventos"><small>Cargando…</small></div>
  </section>
</main>

<div id="toast" class="toast"></div>

<script>
if(!localStorage.getItem('token')) location.href='/login.html';

function toast(m,ok=true){const t=document.getElementById('toast');t.textContent=m;t.style.background=ok?'#2e7d32':'#c62828';t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2200);}
const authFetch=(url,opt={})=>{const tok=localStorage.getItem('token');const h={...(opt.headers||{})};if(tok)h.Authorization='Bearer '+tok;return fetch(url,{...opt,headers:h});};
function parseJwt(t){try{const b=t.split('.')[1].replace(/-/g,'+').replace(/_/g,'/');return JSON.parse(atob(b));}catch{return {};}}
async function ensureClienteId(){const c=+localStorage.getItem('idCliente')||0;if(c)return c;const t=localStorage.getItem('token');if(!t)return 0;const p=parseJwt(t);const id=p.idCliente??p.clienteId??p.id??p.userId??p.sub??0;if(id){localStorage.setItem('idCliente',String(id));return +id;}return 0;}

async function fetchEventos(){
  const cont=document.getElementById('historial-eventos');
  const id=await ensureClienteId();if(!id){cont.innerHTML='<small>Inicia sesión para ver tus eventos.</small>';return;}
  try{
    const r=await authFetch(`/api/eventos?clienteId=${id}`);if(!r.ok)throw 0;
    const data=await r.json();
    if(!data.length){cont.innerHTML='<small>No tienes eventos aún.</small>';return;}
    cont.innerHTML=data.map(e=>`
      <div class="card">
        <strong>Evento #${e.idEvento}</strong> — ${e.tipoEvento||'Sin tipo'}
        <div><b>Fecha:</b> ${e.fechaEvento||'—'} ${e.horaEvento||''}</div>
        <div><b>Invitados:</b> ${e.invitados??'—'}</div>
        <div><b>Detalles:</b> ${e.detalles||'—'}</div>
        <div><b>Dirección:</b> ${e.distrito||''} ${e.direccion||''}</div>
        <div><b>Estado:</b> ${e.estado||'EN_REVISION'}</div>
      </div>
    `).join('');
  }catch{cont.innerHTML='<small>Error cargando eventos.</small>';}
}

document.getElementById('form-evento').addEventListener('submit',async e=>{
  e.preventDefault();
  const idCliente=await ensureClienteId();if(!idCliente){toast('Inicia sesión',false);return;}
  const body={
    idCliente,
    tipo_evento:document.getElementById('tipo_evento').value||null,
    invitados:Number(document.getElementById('invitados').value||0)||null,
    fechaEvento:document.getElementById('fecha').value||null,
    horaEvento:document.getElementById('hora').value||null,
    estado:'EN_REVISION',
    distrito:document.getElementById('distrito').value||null,
    direccion:document.getElementById('direccion').value?.trim()||null,
    referencia:document.getElementById('referencia').value?.trim()||null,
    detalles:document.getElementById('detalles').value?.trim()||null,
    comentarios:document.getElementById('detalles').value?.trim()||null
  };
  if(!body.fechaEvento){toast('Elige una fecha',false);return;}
  if(!body.distrito||!body.direccion){toast('Completa distrito y dirección',false);return;}
  try{
    const r=await authFetch('/api/eventos',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    if(!r.ok)throw new Error((await r.json().catch(()=>({}))).error||'Error');
    const {idEvento}=await r.json();
    toast(`Evento #${idEvento} registrado (EN_REVISION)`);e.target.reset();fetchEventos();
  }catch(err){toast(err.message||'Error',false);}
});
fetchEventos();
</script>
</body>
</html>
